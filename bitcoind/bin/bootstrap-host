#!/bin/bash

set -eu
set -o pipefail
#set -x # for temporary debugging

# where the repo goes
# N.B., if this changes, we need to update it in upstart.init
LOCAL_REPO_DIR=/opt/bitcoin-flow/repos/bitcoin-flow
mkdir -p "${LOCAL_REPO_DIR}"

# clone the repo
git clone git@github.com:drausin/bitcoin-flow.git "${LOCAL_REPO_DIR}"

# define the bitcoind root dir
ROOT_DIR="${LOCAL_REPO_DIR}/bitcoind"

# ensure ROOT_DIR exists
[[ -d "${ROOT_DIR}" ]]

# grab the configuration we need
source "${ROOT_DIR}/conf/bitcoind.properties"
aws s3 cp "${S3_SECURE_CONF_FILEPATH}" "${ROOT_DIR}/conf/bitcoind.secure.properties"

# sync latest saved blockchain state
"${ROOT_DIR}bin/restore-data"

# start the full node via upstart
cp "${ROOT_DIR}/conf/upstart.init" > /etc/init/bitcoind.init
start bitcoind
